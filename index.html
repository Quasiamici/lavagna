<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavagna</title>
</head>
<body>
    <h1>Lavagna</h1>
    <div id="messages"></div>
    <form id="message-form">
        <input type="text" id="message-input" placeholder="Scrivi un messaggio" required />
        <button type="submit">Invia</button>
    </form>

    <script>
        const REPO_OWNER = "Quasiamici";
        const REPO_NAME = "lavagna";

        // Carica i messaggi dalla lavagna
        async function loadMessages() {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/messages.json`);

                if (!response.ok) {
                    throw new Error(`Errore ${response.status}: Impossibile caricare i messaggi.`);
                }

                const data = await response.json();
                const content = atob(data.content); // Decodifica il contenuto Base64
                const messages = JSON.parse(content);

                // Mostra i messaggi nella pagina
                const messagesElement = document.getElementById("messages");
                messagesElement.innerHTML = messages
                    .map(msg => `<p>${msg}</p>`)
                    .join("");
            } catch (error) {
                console.error("Errore nel caricamento dei messaggi:", error);
                document.getElementById("messages").innerHTML = "Impossibile caricare i messaggi.";
            }
        }

        // Invia un nuovo messaggio alla lavagna
        async function addMessage(event) {
            event.preventDefault();

            const messageInput = document.getElementById("message-input");
            const message = messageInput.value.trim();

            if (!message) return;

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                    method: "POST",
                    headers: {
                        "Accept": "application/vnd.github.v3+json",
                        "Authorization": `Bearer GITHUB_PAT_SECRET` // Non necessario se non Ã¨ richiesto nel frontend
                    },
                    body: JSON.stringify({
                        event_type: "add-message",
                        client_payload: { message }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Errore ${response.status}: Impossibile inviare il messaggio.`);
                }

                alert("Messaggio inviato con successo!");
                messageInput.value = "";
                loadMessages();
            } catch (error) {
                console.error("Errore durante l'invio del messaggio:", error);
                alert("Errore durante l'invio del messaggio.");
            }
        }

        document.getElementById("message-form").addEventListener("submit", addMessage);

        // Carica i messaggi all'avvio
        loadMessages();
    </script>
</body>
</html>
