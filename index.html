<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavagna</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #message-list { list-style-type: none; padding: 0; }
        li { padding: 8px; background-color: #f0f0f0; margin-bottom: 4px; }
        #input-form { margin-bottom: 20px; }
        input, button { padding: 8px; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Lavagna</h1>

    <!-- Form per inserire un nuovo messaggio -->
    <div id="input-form">
        <input type="text" id="new-message" placeholder="Scrivi un messaggio" />
        <button onclick="addMessage()">Aggiungi</button>
    </div>

    <ul id="message-list"></ul>

    <script>
        // Funzione per caricare i messaggi esistenti
        function loadMessages() {
            fetch('https://raw.githubusercontent.com/Quasiamici/lavagna/main/messages.json')
                .then(response => response.json())
                .then(data => {
                    let messageList = document.getElementById('message-list');
                    messageList.innerHTML = ''; // Pulisce la lista esistente

                    // Aggiungi ogni messaggio
                    data.forEach(message => {
                        let messageItem = document.createElement('li');
                        messageItem.textContent = message.message;
                        messageList.appendChild(messageItem);
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei messaggi:', error);
                });
        }

        // Funzione per aggiungere un nuovo messaggio
        function addMessage() {
            const newMessage = document.getElementById('new-message').value;
            if (newMessage.trim() === '') {
                alert('Il messaggio non puÃ² essere vuoto!');
                return;
            }

            const newEntry = {
                message: newMessage,
                date: new Date().toISOString()
            };

            // Aggiungi il messaggio al file JSON nel repository
            updateMessages(newEntry);
            document.getElementById('new-message').value = ''; // Resetta il campo di input
            loadMessages();  // Ricarica i messaggi
        }

        // Funzione per aggiornare il file messages.json tramite un trigger GitHub Action
        function updateMessages(newEntry) {
            fetch('https://api.github.com/repos/Quasiamici/lavagna/contents/messages.json', {
                method: 'GET', // Ottieni il file esistente
                headers: {
                    'Authorization': 'Bearer ' + 'TOKEN_GITHUB',  // Usa il tuo token GitHub segreto
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                let messages = JSON.parse(atob(data.content));  // Decodifica il contenuto in base64

                // Aggiungi il nuovo messaggio, senza duplicati
                const existingMessages = messages.map(item => item.message);
                if (!existingMessages.includes(newEntry.message)) {
                    messages.push(newEntry);
                }

                // Invio dell'aggiornamento al file messages.json
                const updatedContent = btoa(JSON.stringify(messages)); // Codifica il JSON in base64

                return fetch('https://api.github.com/repos/Quasiamici/lavagna/contents/messages.json', {
                    method: 'PUT',  // Aggiorna il file
                    headers: {
                        'Authorization': 'Bearer ' + 'TOKEN_GITHUB',  // Usa il token GitHub
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Aggiunto un nuovo messaggio',
                        committer: {
                            name: 'GitHub Actions Bot',
                            email: 'actions@github.com'
                        },
                        content: updatedContent
                    })
                });
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Errore nell\'aggiornamento del file:', error));
        }

        // Carica i messaggi all'inizio
        window.onload = loadMessages;
    </script>
</body>
</html>
